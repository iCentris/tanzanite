<html>

<head>
  <title>Client Sign-in UI</title>
</head>

<body>
  <form id="login-form" style="display:none;">
    <div>
      <label for="username">Username:</label><br />
      <input type="text" value="" id="username" />
    </div>
    <div>
      <label for="Password">Password:</label><br />
      <input type="text" value="" id="password" />
    </div>
    <div>
      <input type="submit" value="Login" />
    </div>
  </form>

  <form id="payload-form" style="display:none;" method="post">
    <input type="hidden" name="payload" />
  </form>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>
    var LS_KEY = '_CLIENT_KEY_';
    function getRequestVars() {
      var params = new URLSearchParams(window.location.search);

      return {
        signin_endpoint_url: params.get('signin_endpoint_url'),
        return_url: params.get('return_url')
      };
    }

    // fetch the validation identifier
    function getIdentifier() {
      return localStorage.getItem(LS_KEY);
    }
    function getIdFromUsername(username) {
      return 1;
    }

    function setIdentifier(id) {
      return localStorage.setItem(LS_KEY, id)
    }

    // check if the given client is authenticated
    function isAuthenticated(id) {
      //do whatever to authenticate the user in your system
      if (!id) return false;

      return id;
    }

    function buildPayload(id) {
      return JSON.stringify({
        id: id
      });
    }

    function handleVibeAuthSuccess(res, return_url) {
      var $payload_form = $('#payload-form');
      var $payload_field = $payload_form.find('input[name="payload"]');

      $payload_field.val(res);

      $payload_form.prop('action', return_url);
      //$payload_form.submit();
    }

    function buildPayload(id) {
      return JSON.stringify({
        id: id
      });
    }

    function handleIsAuthenticated(id, signin_endpoint_url, return_url) {
      var payload = buildPayload(id);
      $.post(signin_endpoint_url, {
        payload: payload
      }, function (res) {
        console.log(res);
        return handleVibeAuthSuccess(res, return_url);
      });
    }

    function handleNotAuthenticated() {
      var $login_form = $('#login-form');
      $login_form.show();

      $login_form.on('submit', function (e) {
        e.preventDefault();
        var username = $(this).find('[name="username"]').val();
        if (username === "error") return alert('Login failed');

        //successful login!
        var id = getIdFromUsername(username);
        setIdentifier(id);
        window.location.reload(true);
      })
    }

    var id = getIdentifier();
    var params = getRequestVars();
    console.log(params);
    if (isAuthenticated(id)) {
      handleIsAuthenticated(id, params.signin_endpoint_url, params.return_url);
    }
    else {
      handleNotAuthenticated();
    }
  </script>
</body>

</html>